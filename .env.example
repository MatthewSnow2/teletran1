# ============================================================================
# CHAD-CORE ENVIRONMENT CONFIGURATION (V2 Final)
# ============================================================================
# Agent: full-stack-orchestration/security-auditor
#
# Local Development: Copy this file to .env and fill in values
# Production: Use Doppler CLI or 1Password CLI (see deployment/secrets/)
#
# SECURITY WARNING: NEVER commit .env to version control!
# ============================================================================

# ----------------------------------------------------------------------------
# DATABASE (Supabase Postgres + pgvector)
# ----------------------------------------------------------------------------
# Development (local Docker Compose):
DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/chad_core

# Production (Supabase pooler):
# DATABASE_URL=postgresql+asyncpg://postgres.<project>:<password>@aws-0-us-west-1.pooler.supabase.com:5432/postgres
#
# IMPORTANT: This is Supabase's managed pooler on AWS infrastructure.
# You are NOT adopting AWS services directly; Supabase handles all AWS integration.
#
# Connection Pooling Notes:
# - Supabase uses PgBouncer in transaction mode
# - Prepared statements are limited (use SQLAlchemy session pooling)
# - Max connections: See Supabase dashboard (typically 100-500 depending on plan)

# Vector Index Type (controls embedding search strategy)
EMBED_INDEX_TYPE=IVF
# Options:
#   IVF     - Inverted File Index (faster build, lower recall) - DEFAULT for dev/test
#   HNSW    - Hierarchical Navigable Small World (slower build, higher recall) - RECOMMENDED for production
#   FLAT    - Brute force, no index (only for tiny datasets < 1000 rows)
# Requires: pgvector >= 0.5.0 for HNSW support

# ----------------------------------------------------------------------------
# SUPABASE STORAGE (Artifacts: PDFs, images, etc.)
# ----------------------------------------------------------------------------
SUPABASE_URL=https://<project>.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...  # Public anon key (safe for client)
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...  # Service role key (server-side ONLY)

# Artifact storage bucket name
SUPABASE_ARTIFACTS_BUCKET=chad-core-artifacts

# Artifact URL expiration (seconds)
ARTIFACT_URL_EXPIRY=86400  # 24 hours (signed URLs)

# ----------------------------------------------------------------------------
# REDIS (Working Memory, Queues, Rate Limits, Idempotency)
# ----------------------------------------------------------------------------
# Development (local Docker Compose):
REDIS_URL=redis://localhost:6379/0

# Production (Render Redis / Upstash):
# REDIS_URL=redis://default:<password>@redis-12345.c1.us-west-1-1.ec2.cloud.redislabs.com:12345
# OR (Upstash with TLS):
# REDIS_URL=rediss://default:<password>@usw1-blessed-shark-12345.upstash.io:6379

# Queue configuration
REDIS_QUEUE_STREAM=queue:act_tasks
REDIS_QUEUE_CONSUMER_GROUP=chad-core-workers
REDIS_QUEUE_CONSUMER_NAME=worker-1  # Unique per worker instance

# Idempotency key TTL (seconds)
REDIS_IDEMPOTENCY_TTL=86400  # 24 hours

# Rate limiting window (seconds)
REDIS_RATE_LIMIT_WINDOW=60  # 1 minute

# ----------------------------------------------------------------------------
# AUTH & SECURITY
# ----------------------------------------------------------------------------
# JWT configuration
JWT_SECRET_KEY=CHANGE_ME_GENERATE_A_RANDOM_SECRET_KEY_AT_LEAST_32_CHARACTERS_LONG
JWT_ALGORITHM=HS256
JWT_EXPIRATION_MINUTES=60

# HMAC signature validation (shared secret with n8n)
HMAC_SECRET_KEY=CHANGE_ME_SHARED_SECRET_WITH_N8N_ENCRYPT_IN_TRANSIT

# Rate limiting (requests per minute per actor)
RATE_LIMIT_PER_ACTOR=60  # Default: 60 req/min
RATE_LIMIT_ADMIN=300     # Admin actors: 300 req/min
RATE_LIMIT_ANONYMOUS=10  # Anonymous: 10 req/min

# ----------------------------------------------------------------------------
# OPENTELEMETRY (Primary Observability)
# ----------------------------------------------------------------------------
OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317  # Jaeger/Tempo/Collector gRPC endpoint
# OR (HTTP):
# OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318

OTEL_SERVICE_NAME=chad-core
OTEL_TRACES_ENABLED=true

# Sampling ratio (0.0 to 1.0)
OTEL_TRACES_SAMPLER=parentbased_always_on  # Always sample (dev); use probabilistic in prod
# OTEL_TRACES_SAMPLER=parentbased_traceidratio
# OTEL_TRACES_SAMPLER_ARG=0.1  # Sample 10% of traces

# Instrumentation: fastapi, httpx, sqlalchemy, redis ONLY
# No AWS, no boto3, no unnecessary packages

# ----------------------------------------------------------------------------
# LANGFUSE (Optional LLM Observability - SDK hooks commented in code)
# ----------------------------------------------------------------------------
# Uncomment to enable Langfuse integration:
# LANGFUSE_PUBLIC_KEY=pk-lf-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# LANGFUSE_SECRET_KEY=sk-lf-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
# LANGFUSE_HOST=https://cloud.langfuse.com
# LANGFUSE_ENABLED=false  # Set to true when keys are configured

# ----------------------------------------------------------------------------
# REFLEX ROUTER (Small-Model Rules Engine)
# ----------------------------------------------------------------------------
REFLEX_STRATEGY=rules
# Options:
#   rules - Regex-based pattern matching (fast, deterministic) - DEFAULT
#   slm   - Small language model for intent classification (TODO: implement)

# If using slm strategy (future):
# REFLEX_SLM_MODEL=distilbert-base-uncased
# REFLEX_SLM_CONFIDENCE_THRESHOLD=0.8  # Fallback to LangGraph if < threshold

# ----------------------------------------------------------------------------
# API SERVER
# ----------------------------------------------------------------------------
API_HOST=0.0.0.0
API_PORT=8000
API_WORKERS=4  # Uvicorn workers (set to CPU count in production)

# CORS settings
API_CORS_ORIGINS=http://localhost:5173,https://your-netlify-app.netlify.app
API_CORS_ALLOW_CREDENTIALS=true

# Request timeout (seconds)
API_REQUEST_TIMEOUT=300  # 5 minutes (for long-running agent executions)

# ----------------------------------------------------------------------------
# LOGGING
# ----------------------------------------------------------------------------
LOG_LEVEL=INFO  # Options: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_FORMAT=json  # Options: json, text
LOG_FILE=/var/log/chad-core/app.log  # Optional file logging (leave empty for stdout only)

# ----------------------------------------------------------------------------
# HTTP ADAPTERS (Upgradeable to MCP Servers)
# ----------------------------------------------------------------------------
# Comment: These are HTTP adapters today; can be upgraded to MCP protocol later.
# Each adapter runs as separate service with --adapter= flag.

# Adapter base URLs (for remote deployment)
ADAPTER_NOTION_URL=http://localhost:8001
ADAPTER_GOOGLE_URL=http://localhost:8002
ADAPTER_GITHUB_URL=http://localhost:8003
ADAPTER_OUTLOOK_URL=http://localhost:8004
ADAPTER_SUPABASE_URL=http://localhost:8005

# ----------------------------------------------------------------------------
# ADAPTER CREDENTIALS (Encrypt in production!)
# ----------------------------------------------------------------------------
# Notion
NOTION_API_KEY=secret_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
NOTION_VERSION=2022-06-28  # API version

# Google (Service Account)
GOOGLE_SERVICE_ACCOUNT_JSON=/path/to/service-account.json
# OR (inline JSON):
# GOOGLE_SERVICE_ACCOUNT_JSON={"type":"service_account","project_id":"..."}

# GitHub
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
GITHUB_API_VERSION=2022-11-28

# Outlook (OAuth2 Client Credentials)
OUTLOOK_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
OUTLOOK_CLIENT_SECRET=CHANGE_ME_ENCRYPT_IN_PRODUCTION
OUTLOOK_TENANT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

# Supabase Admin (for adapter admin operations, different from main service key)
SUPABASE_ADMIN_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# ----------------------------------------------------------------------------
# SECRETS MANAGEMENT (Production)
# ----------------------------------------------------------------------------
# Local: Use .env file (gitignored)
# Production: Use Doppler CLI or 1Password CLI
#
# Doppler Setup:
#   1. Install CLI: curl -Ls https://cli.doppler.com/install.sh | sh
#   2. Login: doppler login
#   3. Setup project: doppler setup --project chad-core --config production
#   4. Add secrets: doppler secrets set DATABASE_URL="..."
#   5. Run: doppler run -- uvicorn apps.core_api.main:app
#
# 1Password Setup:
#   1. Install CLI: https://developer.1password.com/docs/cli/get-started/
#   2. Create .env.production in vault
#   3. Run: op run --env-file=".env.production" -- uvicorn apps.core_api.main:app
#
# OAuth Token Encryption:
#   - NEVER store OAuth tokens in plain Postgres
#   - Encrypt with Fernet or delegate to secret manager
#   - Rotate tokens periodically
#   - See: deployment/secrets/doppler-integration.md

# ----------------------------------------------------------------------------
# DEPLOYMENT TARGETS
# ----------------------------------------------------------------------------
# FastAPI API: Render / Fly.io / DigitalOcean / Cloudflare Workers
# Queue Worker: Same as API (separate service)
# Run Viewer UI: Netlify (React + Vite)
# n8n: n8n Cloud (outer orchestration)
# Database: Supabase Postgres (AWS-hosted; no direct AWS account needed)
# Redis: Render Redis / Upstash

# Environment-specific overrides:
ENVIRONMENT=development  # Options: development, staging, production

# ----------------------------------------------------------------------------
# FEATURE FLAGS (Optional)
# ----------------------------------------------------------------------------
FEATURE_LANGFUSE_ENABLED=false
FEATURE_SWARM_ROUTER_ENABLED=false  # Swarm router is stub only
FEATURE_WEBHOOK_NOTIFICATIONS=false  # Future: WebSocket notifications
FEATURE_AUTO_ROLLBACK=false  # Future: Automatic compensating actions

# ----------------------------------------------------------------------------
# AGENT SIGN-OFF
# ----------------------------------------------------------------------------
# ✅ full-stack-orchestration/security-auditor
# ✅ deployment-strategies/deployment-engineer
